---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Hero from '../components/Hero.astro';
import About from '../components/About.astro';
import TypefacesGrid from '../components/TypefacesGrid.astro';
import FontsInUseCarousel from '../components/FontsInUseCarousel.astro';
import Footer from '../components/Footer.astro';
import { safeLoadQuery } from '../sanity/lib/safe-fetch';
import { urlForImage } from '../sanity/lib/url-for-image';

// Generic fallbacks when Sanity is unavailable (no real copy)
const noImagePlaceholderSvg =
  "data:image/svg+xml," +
  encodeURIComponent(
    '<svg xmlns="http://www.w3.org/2000/svg" width="560" height="400" viewBox="0 0 560 400"><rect fill="#f5f5f4" width="560" height="400"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#a8a29e" font-family="system-ui,sans-serif" font-size="14">No image</text></svg>'
  );
const fallbackHeroItems = [
  { type: 'image' as const, src: '/hero.png', alt: 'Hero image' },
];
const fallbackAboutText = 'Description';
const fallbackTypefaces = [
  { name: 'Typeface name', category: 'Category', styles: 0, slug: 'typeface-name', image: noImagePlaceholderSvg },
];
const fallbackFontsInUse = [
  { image: noImagePlaceholderSvg, alt: 'Font in use' },
];

// Fetch homepage content (aboutText, hero, typeface order, fonts in use carousel)
const { data: homepageSettings } = await safeLoadQuery<{
  aboutText?: string;
  heroItems?: Array<{ type?: string; image?: unknown; videoUrl?: string; alt?: string }>;
  typefaceOrder?: Array<{ _ref: string }>;
  fontsInUse?: Array<{ image?: unknown; alt?: string }>;
} | null>({
  query: `*[_type == "homepageSettings"][0]{
    aboutText,
    heroItems,
    typefaceOrder[]->{ name, slug, category, styles, image { asset } },
    fontsInUse
  }`,
});

// Fallback to legacy siteSettings if homepageSettings is empty (migration)
const { data: legacySettings } = await safeLoadQuery<{
  aboutText?: string;
  heroItems?: Array<{ type?: string; image?: unknown; videoUrl?: string; alt?: string }>;
  fontsInUse?: Array<{ image?: unknown; alt?: string }>;
} | null>({
  query: `*[_type == "siteSettings"][0]{
    aboutText,
    heroItems,
    fontsInUse
  }`,
});

const settings = homepageSettings ?? legacySettings ?? {};
const heroItems: Array<{ type: 'image' | 'video'; src: string; alt?: string }> =
  settings.heroItems?.length
    ? settings.heroItems.map((item) => {
        const src =
          item.type === 'video'
            ? item.videoUrl ?? ''
            : item.image
              ? urlForImage(item.image).url()
              : '';
        return {
          type: (item.type as 'image' | 'video') ?? 'image',
          src,
          alt: item.alt,
        };
      }).filter((i) => i.src)
    : fallbackHeroItems;

const aboutText = settings.aboutText ?? fallbackAboutText;

// Typefaces: use homepage order when set, else fetch all ordered by typeface.order
const orderedTypefaces = homepageSettings?.typefaceOrder;
const { data: fallbackTypefacesData } = await safeLoadQuery<Array<{
  name: string;
  slug?: { current: string };
  category?: string;
  styles?: number;
  image?: { asset?: { _ref: string } };
}>>({
  query: `*[_type == "typeface"] | order(order asc, name asc){
    name,
    slug,
    category,
    styles,
    image { asset }
  }`,
});

const typefacesData = orderedTypefaces?.length
  ? orderedTypefaces
  : fallbackTypefacesData ?? [];
const typefacesFromSanity = typefacesData.length > 0;

const typefaces =
  typefacesData?.length
    ? typefacesData.map((t) => ({
        name: t.name,
        category: t.category ?? '',
        styles: t.styles ?? 0,
        slug: t.slug?.current ?? t.name.toLowerCase().replace(/\s+/g, '-'),
        image: t.image?.asset ? urlForImage(t.image.asset).width(1600).fit('max').url() : noImagePlaceholderSvg,
      }))
    : fallbackTypefaces;

const fontsInUse =
  settings.fontsInUse?.length
    ? settings.fontsInUse.map((item) => ({
        image: item.image ? urlForImage(item.image?.asset ?? item.image).width(1200).fit('max').url() : '',
        alt: item.alt ?? '',
      })).filter((i) => i.image)
    : fallbackFontsInUse;
---

<BaseLayout
  title="Haus Type | Type Foundry"
  description={aboutText}
  image={heroItems[0]?.type === 'image' ? heroItems[0].src : '/hero.png'}
>
  <div class="relative">
    {import.meta.env.DEV && !typefacesFromSanity && (
      <div class="bg-amber-100 border-b border-amber-300 text-amber-900 px-4 py-2 text-center text-sm">
        Could not load typefaces from Sanity. Showing generic placeholders. Check project id and dataset, and that content is published.
      </div>
    )}
    <Hero items={heroItems} />
    <div class="absolute top-0 left-0 right-0 z-10">
      <Header variant="dark" />
    </div>
  </div>
  <main class="flex-1" data-reveal>
    <About text={aboutText} />
    <TypefacesGrid typefaces={typefaces} />
    <FontsInUseCarousel items={fontsInUse} />
  </main>
  <Footer />
</BaseLayout>
