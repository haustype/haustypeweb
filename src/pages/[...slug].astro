---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import PortableText from '../components/PortableText.astro';
import { getCollection } from 'astro:content';
import { safeLoadQuery } from '../sanity/lib/safe-fetch';

export async function getStaticPaths() {
  const { data: sanityPages } = await safeLoadQuery<Array<{ slug?: { current: string } }>>({
    query: `*[_type == "page"]{ slug }`,
  });

  if (sanityPages?.length) {
    return sanityPages.map((p) => ({
      params: { slug: p.slug?.current ?? '' },
      props: { source: 'sanity' as const },
    }));
  }

  const pages = await getCollection('pages');
  return pages.map((page) => ({
    params: { slug: page.slug },
    props: { page, source: 'astro' as const },
  }));
}

const { slug } = Astro.params;
const { source, page: astroPage } = Astro.props;

let title = '';
let description = '';
let body: unknown = null;

type PageSection = {
  _key?: string;
  sectionType: 'typeTester' | 'characterViewer' | 'buyButton' | 'content';
  typeface?: { slug?: { current: string }; name?: string; collectionId?: string };
  content?: unknown;
};

let pageSections: PageSection[] = [];

if (source === 'sanity') {
  const { data: page } = await safeLoadQuery<{
    title: string;
    description?: string;
    body?: unknown;
    pageSections?: PageSection[] | null;
  }>({
    query: `*[_type == "page" && slug.current == $slug][0]{
      title,
      description,
      body,
      pageSections[]{
        _key,
        sectionType,
        content,
        typeface->{ slug, name, collectionId }
      }
    }`,
    params: { slug },
  });
  if (page) {
    title = page.title;
    description = page.description ?? '';
    body = page.body;
    pageSections = page.pageSections ?? [];
  }
} else if (astroPage) {
  title = astroPage.data.title;
  description = astroPage.data.description ?? '';
}

const astroContent = astroPage ? await astroPage.render() : null;
---

<BaseLayout
  title={`${title} | Haus Type`}
  description={description}
>
  <Header />
  <main class="bg-haus-grey flex-1" data-reveal>
    <article class="w-full px-8 py-20">
      <div class="w-full max-w-content mx-auto grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-16 mb-16">
        <header>
          <h1 class="font-normal text-black">{title}</h1>
        </header>
        <div class="prose max-w-none">
          {source === 'sanity' && body ? (
            <PortableText value={body} />
          ) : astroContent ? (
            <astroContent.Content />
          ) : null}
        </div>
      </div>
      {source === 'sanity' && pageSections.length > 0 && (
        <div class="w-full flex flex-col gap-16">
          {pageSections.map((section) => {
            const collectionSlug = section.typeface?.slug?.current;
            const typefaceName = section.typeface?.name;
            const collectionId = section.typeface?.collectionId;
            if (section.sectionType === 'typeTester' && collectionSlug) {
              return (
                <div class="w-full">
                  <fontdue-type-testers collection-slug={collectionSlug} />
                </div>
              );
            }
            if (section.sectionType === 'characterViewer' && collectionSlug) {
              return (
                <div class="w-full">
                  <fontdue-character-viewer collection-slug={collectionSlug} />
                </div>
              );
            }
            if (section.sectionType === 'buyButton' && collectionId && typefaceName) {
              return (
                <div class="w-full">
                  <fontdue-buy-button
                    collection-id={collectionId}
                    collection-name={typefaceName}
                  />
                </div>
              );
            }
            if (section.sectionType === 'content' && section.content) {
              return (
                <div class="w-full prose max-w-none">
                  <PortableText value={section.content} />
                </div>
              );
            }
            return null;
          })}
        </div>
      )}
    </article>
  </main>
  <Footer />
</BaseLayout>
