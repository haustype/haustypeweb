---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import PortableText from '../../components/PortableText.astro';
import { getCollection } from 'astro:content';
import { safeLoadQuery } from '../../sanity/lib/safe-fetch';

export async function getStaticPaths() {
  // Try Sanity first
  const { data: sanityPosts } = await safeLoadQuery<Array<{ slug?: { current: string } }>>({
    query: `*[_type == "post" && !draft]{ slug }`,
  });

  if (sanityPosts?.length) {
    return sanityPosts.map((p) => ({
      params: { slug: p.slug?.current ?? '' },
      props: { source: 'sanity' as const },
    }));
  }

  const posts = await getCollection('blog', ({ data }) => !data.draft);
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post, source: 'astro' as const },
  }));
}

const { slug } = Astro.params;
const { source, post: astroPost } = Astro.props;

let title = '';
let description = '';
let pubDate: Date = new Date();
let author = '';
let body: unknown = null;
let image: string | undefined;

if (source === 'sanity') {
  const { data: post } = await safeLoadQuery<{
    title: string;
    description?: string;
    publishedAt?: string;
    author?: string;
    mainImage?: unknown;
    body?: unknown;
  }>({
    query: `*[_type == "post" && slug.current == $slug && !draft][0]{
      title,
      description,
      publishedAt,
      author,
      mainImage,
      body
    }`,
    params: { slug },
  });
  if (post) {
    title = post.title;
    description = post.description ?? '';
    pubDate = post.publishedAt ? new Date(post.publishedAt) : new Date();
    author = post.author ?? '';
    body = post.body;
    image = post.mainImage ? (await import('../../sanity/lib/url-for-image')).urlForImage(post.mainImage).url() : undefined;
  }
} else if (astroPost) {
  title = astroPost.data.title;
  description = astroPost.data.description ?? '';
  pubDate = astroPost.data.pubDate;
  author = astroPost.data.author ?? '';
  image = astroPost.data.image;
}

const astroContent = astroPost ? await astroPost.render() : null;
---

<BaseLayout
  title={`${title} | Haus Type`}
  description={description}
  image={image}
>
  <Header />
  <main class="bg-haus-grey flex-1" data-reveal>
    <article class="w-full px-8 py-20">
      <div class="w-full max-w-content mx-auto grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-16">
        <header class="flex flex-col gap-4">
          <h1 class="font-normal text-black">{title}</h1>
          <div class="flex flex-col gap-1">
            {author && (
              <span class="text-sm text-[#999999]">By {author}</span>
            )}
            <time datetime={pubDate.toISOString()} class="text-[#999999] text-sm">
              {pubDate.toLocaleDateString('en-GB', { dateStyle: 'long' })}
            </time>
          </div>
        </header>
        <div class="prose max-w-none">
          {source === 'sanity' && body ? (
            <PortableText value={body} />
          ) : astroContent ? (
            <astroContent.Content />
          ) : null}
        </div>
      </div>
    </article>
  </main>
  <Footer />
</BaseLayout>
