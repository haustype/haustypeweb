---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { safeLoadQuery } from '../../sanity/lib/safe-fetch';

export async function getStaticPaths() {
  const { data: typefaces } = await safeLoadQuery<Array<{ slug?: { current: string } }>>({
    query: `*[_type == "typeface"]{ slug }`,
  });

  if (typefaces?.length) {
    return typefaces.map((t) => ({
      params: { slug: t.slug?.current ?? '' },
    }));
  }

  const fallbackSlugs = ['metrostile', 'guglielmo-marconi', 'aerial-quango', 'salsiccia', 'cinema-clubs', 'puerto-vallarta', 'psyche-delica'];
  return fallbackSlugs.map((slug) => ({ params: { slug } }));
}

const fallbackFonts: Record<string, { name: string; collectionId?: string }> = {
  metrostile: { name: 'Metrostile', collectionId: 'Rm9udENvbGxlY3Rpb246MTkzNzI0Mzc0MDk1NTc3NDcwMA==' },
  'guglielmo-marconi': { name: 'Guglielmo Marconi*' },
  'aerial-quango': { name: 'Aerial Quango' },
  salsiccia: { name: 'SALS ICCIA' },
  'cinema-clubs': { name: 'Cinema Clubs' },
  'puerto-vallarta': { name: 'Puerto Vallarta' },
  'psyche-delica': { name: 'PSYCHE DELICA' },
};

const { slug } = Astro.params;

const { data: typefacesData } = await safeLoadQuery<Array<{
  name: string;
  slug?: { current: string };
  collectionId?: string;
}>>({
  query: `*[_type == "typeface"]{ name, slug, collectionId }`,
});

const font = typefacesData?.find((t) => t.slug?.current === slug)
  ? { name: typefacesData.find((t) => t.slug?.current === slug)!.name, collectionId: typefacesData.find((t) => t.slug?.current === slug)!.collectionId }
  : fallbackFonts[slug ?? ''] ?? { name: slug ?? 'Font' };
---

<BaseLayout
  title={`${font.name} | Haus Type`}
  description={`${font.name} - Explore and purchase from Haus Type foundry.`}
>
  <Header />
  <main class="bg-haus-grey min-h-screen">
    <article class="w-full px-8 py-16">
      <header class="w-full max-w-content mx-auto mb-8">
        <h1 class="text-[20px] font-normal text-black">{font.name}</h1>
      </header>
      <div class="w-full">
        <fontdue-type-testers collection-slug={slug} />
      </div>
      <div class="w-full max-w-content mx-auto mt-8">
        {font.collectionId && (
          <fontdue-buy-button
            collection-id={font.collectionId}
            collection-name={font.name}
          />
        )}
      </div>
      <div class="w-full mt-16">
        <fontdue-character-viewer collection-slug={slug} />
      </div>
    </article>
  </main>
  <Footer />
</BaseLayout>
