---
interface Props {
  items: Array<{
    type: 'image' | 'video';
    src: string;
    alt?: string;
  }>;
}

const { items } = Astro.props;
const slides = items.length ? items : [{ type: 'image' as const, src: '/hero-placeholder.jpg', alt: 'Haus Type font display' }];
const isSlideshow = slides.length > 1;
---

<section class="hero-slideshow h-screen flex items-center justify-center relative overflow-hidden" style="background-color: #0a0a0a;">
  <div class="w-full max-w-content px-8 flex justify-center items-center h-full relative">
    {slides.map((item, i) => (
      <div
        class={`hero-slide absolute inset-0 flex justify-center items-center px-8 ${
          isSlideshow ? (i === 0 ? '' : 'invisible') : ''
        }`}
        style={`transition: opacity 1s cubic-bezier(0.4, 0, 0.2, 1); opacity: ${isSlideshow ? 0 : 1};`}
        data-slide
        data-index={i}
      >
        {item.type === 'video' ? (
          <video
            src={item.src}
            autoplay
            muted
            loop
            playsinline
            class="max-w-full max-h-[65vh] w-auto object-contain"
          />
        ) : (
          <img
            src={item.src}
            alt={item.alt ?? 'Font showcase'}
            width={1200}
            height={800}
            class="max-w-full max-h-[65vh] w-auto object-contain"
            fetchpriority={i === 0 ? 'high' : undefined}
          />
        )}
      </div>
    ))}
  </div>
  {isSlideshow && (
    <script>
      (function () {
        const container = document.querySelector('.hero-slideshow');
        if (!container) return;
        const slideEls = container.querySelectorAll('[data-slide]');
        if (slideEls.length <= 1) return;

        const FADE_MS_DESKTOP = 0;
        const FADE_MS_MOBILE = 800;
        const HOLD_MS = 4000;
        const DESKTOP_BREAKPOINT = 1024;

        let current = 0;
        let autoplayTimer = null;

        function getFadeMs() {
          return window.innerWidth >= DESKTOP_BREAKPOINT ? FADE_MS_DESKTOP : FADE_MS_MOBILE;
        }

        function showSlide(index) {
          const target = Math.max(0, Math.min(index, slideEls.length - 1));
          if (target === current) return;
          const prev = current;
          current = target;
          const fadeMs = getFadeMs();

          slideEls[prev].style.opacity = '0';
          slideEls[prev].style.transition = `opacity ${fadeMs}ms cubic-bezier(0.4, 0, 0.2, 1)`;

          setTimeout(() => {
            slideEls[prev].classList.add('invisible');
            slideEls[current].classList.remove('invisible');
            slideEls[current].style.opacity = '0';
            slideEls[current].style.transition = `opacity ${fadeMs}ms cubic-bezier(0.4, 0, 0.2, 1)`;
            requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                slideEls[current].style.opacity = '1';
              });
            });
          }, fadeMs);
        }

        function advance() {
          if (window.innerWidth >= DESKTOP_BREAKPOINT) return;
          showSlide((current + 1) % slideEls.length);
          autoplayTimer = setTimeout(advance, HOLD_MS + getFadeMs());
        }

        function startAutoplay() {
          stopAutoplay();
          autoplayTimer = setTimeout(advance, HOLD_MS);
        }

        function stopAutoplay() {
          if (autoplayTimer) {
            clearTimeout(autoplayTimer);
            autoplayTimer = null;
          }
        }

        function handleMouseMove(e) {
          if (window.innerWidth < DESKTOP_BREAKPOINT) return;
          const rect = container.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const pct = Math.max(0, Math.min(1, x / rect.width));
          const index = Math.floor(pct * slideEls.length);
          const target = index >= slideEls.length ? slideEls.length - 1 : index;
          showSlide(target);
        }

        function handleMouseLeave() {
          if (window.innerWidth >= DESKTOP_BREAKPOINT) showSlide(0);
        }

        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            slideEls[0].style.opacity = '1';
          });
        });

        container.addEventListener('mousemove', handleMouseMove);
        container.addEventListener('mouseleave', handleMouseLeave);

        if (window.innerWidth < DESKTOP_BREAKPOINT) {
          startAutoplay();
        }

        window.addEventListener('resize', () => {
          if (window.innerWidth < DESKTOP_BREAKPOINT) {
            if (!autoplayTimer) startAutoplay();
          } else {
            stopAutoplay();
            showSlide(0);
          }
        });
      })();
    </script>
  )}
</section>
